name: Cosign Sign Container Test
on: [workflow_dispatch]
jobs:
  Cosign-Sign-Container-Test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Install ca-certificates
        run: sudo apt-get update && sudo apt-get install ca-certificates -y
      - name: Add self signed sigstore cert
        run: sudo cp nginx-selfsigned.crt /usr/local/share/ca-certificates/nginx-selfsigned.crt && sudo update-ca-certificates
      - name: Install cosign
        uses: sigstore/cosign-installer@v3.0.2
        with:
         cosign-release: 'v2.0.1'
      - name: Check install!
        run: cosign version
      - name: Pull Rekor Public Key
        run: curl -k -o rekor.pub https://34.171.57.150/rekor/api/v1/log/publicKey
      - name: Pull Fulcio Root Cert
        run: curl -k -o fulcio.root.crt https://34.171.57.150/fulcio/api/v1/rootCert
      - name: Setup Image
        run: |
          IMAGE_NAME=$(uuidgen) 
          IMAGE=ttl.sh/$IMAGE_NAME:5m
          cosign copy alpine $IMAGE
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"
      - name: Setup Image URL
        run: IMAGE_URL=`cat imageurl`
      - name: Print Image URL
        run: echo "Image URL is: ${{ env.IMAGE_URL }} "
      - name: cosign login
        run: cosign login -u AWS -p eyJwYXlsb2FkIjoiWXBWb0FiQjltY09xTGw5cGdXOXpSYUwrWGtSbGs4QitGMnNmc01VYkdvWmIyb1RETzVNdXdSNFZ1eHlhQ2NKQnhWdVo2Q2oxelR4SUUreHN5aWp6R0xUazVhNVlEWEROZWZkV0U5amplRkhyUy9uSGNTditxVk5OVzRuUkR0ek9NaFpHdWVxb0pTWGV4L2xuNnY4c0NEcDF4czZEKzgxdWtwMzJQV01kSTZjNmlpMGdOR3g2NjEvVVZKenFXT0hGVW1BbThBRDlRRmQ1alZJeEM1NzBIa3FJMnBVVlBHVWtjelZFeC9Pc0pqWGNpRXI3VFNGSnZEQmphWEdMNEFFWE5yejdWNTJyNk84MUJQbUNNeW1SNlR3K2JwNkFza1Q3ZWxkOWJNMmxON0Q3L3g3ZU1JNlFTK2tDUGpOVVBIRlJmdDE2OFFpTkpiUE92SEtEMnhuUHNFYmlDTEZRWHhjSTJPSkVLdGlJeDNtKzlKaVhOaGlGbmx6bmRBTW1iVncwUlFsbEZHL3Q2RUtNcjN0dDlQMEkySFAxSkMycUt4R2g2RGRwWXU2NHNOUWNzaTM5UnQ0MWtjWkEwOWN0aFlGMHlJYTRSeExhN1RwRVdXYWd6SHg2elFtMlFPcHRib1RRUm5qczZUZEM3RDAwRUdVcExaVXlIRXNyaDFkTWRGaGJTZEIyNEJpeFo0K2NnSTE4OWI5NVoxVjJIV0x2OThnbENqSTRtL1NLWXZHN0xLMExqRXJ0OVNwYWYzSWdQMU1vTVVwaGJERDE2ZVlDaWxuWC9raXRiRGFIK1dBaGdEd2tWdG5sbWRpRFptWW5IQWh0SkI1ckVLYnVEb3dBTTFsT0NNR0craHlaY29YMWNQZzNScHFWZkQrWWVPbW56NVo3Q3hkL3NRMndWeG9VejBtQVNzT1h6OVhBUjJSMmt5YkNvaFA5YnZDTk1jcEhuc0QrWkVGWlh4NDJLUkN3ZU5LNG1ESkx4bldMbHB2NEpwaDVub09sVUFRT0hxUlpwMUh4NFdxV01EZzNUMlBzY285ZXJTbGkzM05ndU9JdWpEOXRzZFhvL2Z3djQ3U2NMcG5qT2kwbmFVbE82Y1dkR3JDVmFsMUxXcHNpL1hjZ2E2S3J0cnlJOXBjZ0VWdWRKMzNudmhVbmR5RkhFWWZuYXo3NjhzdTdvbDZBVW5ZOHdRUi9STm9NdEg1ckdzYnJqQXRHVXNldm5WYklYK0Z1MENrRzRseUhMTXdBZks3eHBxY1NJRjhmN1ZoK0JmNzhPVXJ6MVo5TFBleG1hbVNNdjIvSEhlSGg3TysvbUcyZlk2SjRQNVpMcjJYclVDWFpZazQzRG9wbURNTkNIZW9pbDF0SHQ1ZEFUZE9zb3paY3k2RUUyUT09IiwiZGF0YWtleSI6IkFRRUJBSGo2bGM0WElKdy83bG4wSGMwMERNZWs2R0V4SENiWTRSSXBUTUNJNThJblV3QUFBSDR3ZkFZSktvWklodmNOQVFjR29HOHdiUUlCQURCb0Jna3Foa2lHOXcwQkJ3RXdIZ1lKWUlaSUFXVURCQUV1TUJFRURKNWQzTkV0bURFNVlWZFNsZ0lCRUlBN3FvMjg2Zm5BL2ZHZEw2N3VkU3VzaHdlWCtxYzFKaGxtd3REYzNhMTRQZXVRaC9pSlhuTlloTiswMmVnNXQ4M1ZKZ0xCNXRqVzY4NEovTjA9IiwidmVyc2lvbiI6IjIiLCJ0eXBlIjoiREFUQV9LRVkiLCJleHBpcmF0aW9uIjoxNjk3MjAyMjkzfQ== 987780704976.dkr.ecr.us-west-2.amazonaws.com
      - name: Sign Image
        env:
          SIGSTORE_REKOR_PUBLIC_KEY: "rekor.pub"
          SIGSTORE_ROOT_FILE: "fulcio.root.crt"
          SIGSTORE_CT_LOG_PUBLIC_KEY_FILE: "ct_pub.pem"
        run: cosign sign --rekor-url=https://34.171.57.150/rekor --fulcio-url=https://34.171.57.150/fulcio ${{ env.IMAGE }} -y
      - name: Sign ECR Image
        env:
          SIGSTORE_REKOR_PUBLIC_KEY: "rekor.pub"
          SIGSTORE_ROOT_FILE: "fulcio.root.crt"
          SIGSTORE_CT_LOG_PUBLIC_KEY_FILE: "ct_pub.pem"
        run: cosign sign --rekor-url=https://34.171.57.150/rekor --fulcio-url=https://34.171.57.150/fulcio 987780704976.dkr.ecr.us-west-2.amazonaws.com/arubaos/container-manager:1.2.0-alpha.1-arm64 -y
      - name: Verify Image
        env:
          SIGSTORE_REKOR_PUBLIC_KEY: "rekor.pub"
          SIGSTORE_ROOT_FILE: "fulcio.root.crt"
          SIGSTORE_CT_LOG_PUBLIC_KEY_FILE: "ct_pub.pem"
        run: cosign verify --rekor-url=https://34.171.57.150/rekor --certificate-identity https://github.com/${{ github.workflow_ref }} --certificate-oidc-issuer https://token.actions.githubusercontent.com ${{ env.IMAGE }}
      - name: Verify ECR Image
        env:
          SIGSTORE_REKOR_PUBLIC_KEY: "rekor.pub"
          SIGSTORE_ROOT_FILE: "fulcio.root.crt"
          SIGSTORE_CT_LOG_PUBLIC_KEY_FILE: "ct_pub.pem"
        run: cosign verify --rekor-url=https://34.171.57.150/rekor --certificate-identity https://github.com/${{ github.workflow_ref }} --certificate-oidc-issuer https://token.actions.githubusercontent.com 987780704976.dkr.ecr.us-west-2.amazonaws.com/arubaos/container-manager:1.2.0-alpha.1-arm64
